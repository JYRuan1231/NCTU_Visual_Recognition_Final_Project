# Visual_Recognition_Final_Project

## Introduction
The project is training an accurate classification neteork using Efficientnet-B4 for [APTOS 2019 Blindness Detection](https://www.kaggle.com/c/aptos2019-blindness-detection).

## Usage
We training and testing with Python 3.6, pytorch 1.4 and **Need** to reference [timm](https://github.com/rwightman/pytorch-image-models).

## Instruction
1. Train three individual models.
2. Ensembles three models and generate pseudo label of test dataset.
3. Fintune the three models in step.1 with the pseudo label.
4. Repeat step 1 ~ 3 until accuracy stop increasing. (Note: the same origin three model are fine-tuned with every new pseudo label)
5. The best summision file is generated by ensembling fine-tuned models.



In addition, **my model [1](https://drive.google.com/file/d/1MlOk6hoQAE7n3CPOsHvuVClCXv02kljJ/view?usp=sharing) [2](https://drive.google.com/file/d/1-zxxwz3LwSrwEzkzey6A4lIojzT6w7u7/view?usp=sharing) [3](https://drive.google.com/file/d/1vaPhxwr7xsyzUINe38vNveh6-ysl8sQW/view?usp=sharing) can be loaded for ensemble learning**, and this is described in detail in the **Ensemble Learning** section.


Before training data, Upload the training images to `/data/train_images/` and the test data to `/data/test_images/`.

Make sure you have trian and test file(default name: **train.csv and test.csv**) in the `/data/` folder.


### Traning Model

Example:

```
python train.py
```

***important arguments about Traning Model in config.py***

Default:
These arguments is basic setting for model.

| Argument    | Default value |
| ------------|:-------------:|
|model_name             |  efficientb4_v1.pth             |
|batch_size             |  16            |
|accumulation_steps             |  1   (Gradient accumulation)         |
|workers             |  4             |

And, these is related to your training performance.

| Argument    | Default value |
| ------------|:-------------:|
|num_epochs             |  50             |
|optimizer_lr             |  0.001             |
|momentum           |  0.9           |
|weight_decay             |  5e-4            |
|T_mult             |  1 (CosineAnnealingWarmRestarts)           |
|eta_min             |  0.00001           |

Train three new models by running `train.py` three times and name them efficientb4_v1, efficientb4_v2 and efficientb4_v3.

When the program was finished, we will get a traning model file in `/model/`.

```
./models/efficientb4_v1.pth
./models/efficientb4_v2.pth
./models/efficientb4_v3.pth
```

### Ensemble Learning

If we want to ensemble the result of models, make sure we have three models in `/models/` and confirm `model_name`.

In addition, if you want to use my trained model, download this model [1](https://drive.google.com/file/d/1MlOk6hoQAE7n3CPOsHvuVClCXv02kljJ/view?usp=sharing) [2](https://drive.google.com/file/d/1-zxxwz3LwSrwEzkzey6A4lIojzT6w7u7/view?usp=sharing) [3](https://drive.google.com/file/d/1vaPhxwr7xsyzUINe38vNveh6-ysl8sQW/view?usp=sharing) to `/models/` and change the `model_name` to `pseudo_efficientb4_v1`, `pseudo_efficientb4_v2` and `pseudo_efficientb4_v3` in `ensemble_config.py`

Example:

```
python ensemble.py
```

***important arguments about Testing Model in ensemble_config.py***


Default:

| Argument    | Default value |
| ------------|:-------------:|
|model_1              |      efficientb4_v1       |
|model_2              |      efficientb4_v2       |
|model_3              |      efficientb4_v3       |
|submission_csv               |      submission.csv        |

When the program was finished, we will get a csv file in /output/.
```
./output/submission.csv
```

## Pseudo Label
If you want to fine-tuned model with pseudo lable, make sure we have a model in `/models/` and confirm `model_name` and a `pseudo_label.csv` in `/data/`.

> If you are not satisfied with the accuracy of the model, you can change `submission.csv` name to `pseudo_label.csv` then move to `/data/` folder.

Example:

```
python pseudo_train.py
```

Default:


| Argument    | Default value |
| ------------|:-------------:|
|model_name             |  efficientb4_v1.pth             |
|pseudo_model_name             |  pseudo_efficientb4_v1.pth             |
|batch_size             |  16            |
|accumulation_steps             |  1   (Gradient accumulation)         |
|workers             |  4             |

And, these is related to your training performance.

| Argument    | Default value |
| ------------|:-------------:|
|num_epochs             |  20             |
|optimizer_lr             |  0.001             |
|momentum           |  0.9           |
|weight_decay             |  5e-4            |
|T_mult             |  1 (CosineAnnealingWarmRestarts)           |
|eta_min             |  0.00001           |


Train three models by running `pseudo_train.py` three times and name them pseudo_efficientb4_v1, pseudo_efficientb4_v2 and pseudo_efficientb4_v3.

When the program was finished, we will get a traning model file in `/models/`.

```
./models/pseudo_efficientb4_v1.pth
./models/pseudo_efficientb4_v2.pth
./models/pseudo_efficientb4_v3.pth
```


## Result

| Metrics    | value |
| ------------|:-------------:|
|Private Score             |     <img src="image/result.jpg" width=400>          |
